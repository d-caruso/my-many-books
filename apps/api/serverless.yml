# ================================================================
# serverless.yml - Serverless Framework Configuration
# ================================================================

service: my-many-books-api

frameworkVersion: '4.19.1'

provider:
  name: aws
  runtime: nodejs18.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 30
  
  # Environment variables
  environment:
    NODE_ENV: ${self:provider.stage}
    DB_HOST: ${cf:my-many-books-infrastructure-${self:provider.stage}.DatabaseHost, ''}
    DB_PORT: ${cf:my-many-books-infrastructure-${self:provider.stage}.DatabasePort, '3306'}
    DB_NAME: ${env:DB_NAME, 'my_many_books'}
    DB_USER: ${env:DB_USER, 'admin'}
    DB_PASSWORD: ${ssm:/aws/reference/secretsmanager/my-many-books-infrastructure-${self:provider.stage}-db-credentials~false~password, ''}
    DB_SSL: ${env:DB_SSL, 'true'}
    API_VERSION: ${env:API_VERSION, '1.0.0'}
    LOG_LEVEL: ${env:LOG_LEVEL, 'info'}
    
    # Security settings
    API_KEYS_ENABLED: ${env:API_KEYS_ENABLED, 'false'}
    COGNITO_ENABLED: ${env:COGNITO_ENABLED, 'true'}
    COGNITO_USER_POOL_ID: !Ref CognitoUserPool
    COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient
    
    # External service settings
    OPEN_LIBRARY_BASE_URL: ${env:OPEN_LIBRARY_BASE_URL, 'https://openlibrary.org'}
    GOOGLE_BOOKS_API_KEY: ${env:GOOGLE_BOOKS_API_KEY, ''}
    GOOGLE_BOOKS_BASE_URL: ${env:GOOGLE_BOOKS_BASE_URL, 'https://www.googleapis.com/books/v1'}
    
    # Performance settings
    CACHE_TTL: ${env:CACHE_TTL, '3600'}
    REQUEST_TIMEOUT: ${env:REQUEST_TIMEOUT, '10000'}
    MAX_RETRIES: ${env:MAX_RETRIES, '3'}

  # API Gateway configuration
  apiGateway:
    description: My Many Books API - Personal library management system

  # IAM permissions
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: 'arn:aws:logs:*:*:*'
        - Effect: Allow
          Action:
            - apigateway:GET
            - apigateway:POST
            - apigateway:PUT
            - apigateway:DELETE
          Resource: 'arn:aws:apigateway:*::/restapis/*'
        - Effect: Allow
          Action:
            - execute-api:Invoke
          Resource: 'arn:aws:execute-api:*:*:*'
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource: 'arn:aws:secretsmanager:*:*:secret:my-many-books-infrastructure-*'

  # Tags for resource management  
  tags:
    Project: my-many-books
    Environment: ${self:provider.stage}
    Service: api
    CreatedBy: serverless

plugins:
  - serverless-offline

build:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    target: node18
    external:
      - pg-native
      - pg-hstore
      - pg
      - sqlite3
      - mysql
      - mariasql
      - mssql
      - oracle
      - oracledb
      - redis

custom:
  serverless-offline:
    httpPort: 3000
    port: 3000

functions:
  # Single function deployment (recommended for API Gateway)
  api:
    handler: src/handlers/router.handler
    events:
      - http:
          path: /{proxy+}
          method: ANY
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - X-Requested-With
            allowCredentials: true
      - http:
          path: /
          method: ANY
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - X-Requested-With
            allowCredentials: true

  # Separate function deployments (alternative approach)
  # Uncomment below if you prefer separate Lambda functions per resource

  # books-create:
  #   handler: src/handlers/books.createBook
  #   events:
  #     - http:
  #         path: /books
  #         method: post
  #         cors: true

  # books-get:
  #   handler: src/handlers/books.getBook
  #   events:
  #     - http:
  #         path: /books/{id}
  #         method: get
  #         cors: true

  # books-update:
  #   handler: src/handlers/books.updateBook
  #   events:
  #     - http:
  #         path: /books/{id}
  #         method: put
  #         cors: true

  # books-delete:
  #   handler: src/handlers/books.deleteBook
  #   events:
  #     - http:
  #         path: /books/{id}
  #         method: delete
  #         cors: true

  # books-list:
  #   handler: src/handlers/books.listBooks
  #   events:
  #     - http:
  #         path: /books
  #         method: get
  #         cors: true

  # books-search-isbn:
  #   handler: src/handlers/books.searchBooksByIsbn
  #   events:
  #     - http:
  #         path: /books/search/isbn
  #         method: get
  #         cors: true

  # books-import-isbn:
  #   handler: src/handlers/books.importBookFromIsbn
  #   events:
  #     - http:
  #         path: /books/import/isbn
  #         method: post
  #         cors: true

  # authors-create:
  #   handler: src/handlers/authors.createAuthor
  #   events:
  #     - http:
  #         path: /authors
  #         method: post
  #         cors: true

  # authors-get:
  #   handler: src/handlers/authors.getAuthor
  #   events:
  #     - http:
  #         path: /authors/{id}
  #         method: get
  #         cors: true

  # authors-update:
  #   handler: src/handlers/authors.updateAuthor
  #   events:
  #     - http:
  #         path: /authors/{id}
  #         method: put
  #         cors: true

  # authors-delete:
  #   handler: src/handlers/authors.deleteAuthor
  #   events:
  #     - http:
  #         path: /authors/{id}
  #         method: delete
  #         cors: true

  # authors-list:
  #   handler: src/handlers/authors.listAuthors
  #   events:
  #     - http:
  #         path: /authors
  #         method: get
  #         cors: true

  # authors-books:
  #   handler: src/handlers/authors.getAuthorBooks
  #   events:
  #     - http:
  #         path: /authors/{id}/books
  #         method: get
  #         cors: true

  # Health check
  health:
    handler: src/handlers/health.healthCheck
    events:
      - http:
          path: /health
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - X-Requested-With
            allowCredentials: true

  readiness:
    handler: src/handlers/health.readinessCheck
    events:
      - http:
          path: /readiness
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - X-Requested-With
            allowCredentials: true

# CloudFormation Resources
resources:
  Resources:
    # Cognito User Pool
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-user-pool-${self:provider.stage}
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: true
        EmailConfiguration:
          EmailSendingAccount: COGNITO_DEFAULT
        VerificationMessageTemplate:
          DefaultEmailOption: CONFIRM_WITH_LINK
          EmailSubject: "Verify your My Many Books account"
          EmailMessage: "Please click the link below to verify your email address for My Many Books: {####}"
        AccountRecoverySetting:
          RecoveryMechanisms:
            - Name: verified_email
              Priority: 1
        UserAttributeUpdateSettings:
          AttributesRequireVerificationBeforeUpdate:
            - email
        AdminCreateUserConfig:
          AllowAdminCreateUserOnly: false
        UserPoolTags:
          Project: my-many-books
          Environment: ${self:provider.stage}
          Service: auth
          CreatedBy: serverless

    # Cognito User Pool Client
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-client-${self:provider.stage}
        UserPoolId: !Ref CognitoUserPool
        GenerateSecret: false
        AllowedOAuthFlowsUserPoolClient: true
        AllowedOAuthFlows:
          - code
          - implicit
        AllowedOAuthScopes:
          - email
          - openid
          - profile
        SupportedIdentityProviders:
          - COGNITO
        CallbackURLs:
          - http://localhost:3000
          - https://localhost:3000
          - https://${self:service}-web-${self:provider.stage}.s3-website-${self:provider.region}.amazonaws.com
        LogoutURLs:
          - http://localhost:3000
          - https://localhost:3000
          - https://${self:service}-web-${self:provider.stage}.s3-website-${self:provider.region}.amazonaws.com
        AccessTokenValidity: 24
        IdTokenValidity: 24
        RefreshTokenValidity: 30
        TokenValidityUnits:
          AccessToken: hours
          IdToken: hours
          RefreshToken: days

    # Cognito User Pool Domain
    CognitoUserPoolDomain:
      Type: AWS::Cognito::UserPoolDomain
      Properties:
        Domain: ${self:service}-auth-${self:provider.stage}
        UserPoolId: !Ref CognitoUserPool

    # Cognito Identity Pool
    CognitoIdentityPool:
      Type: AWS::Cognito::IdentityPool
      Properties:
        IdentityPoolName: ${self:service}-identity-pool-${self:provider.stage}
        AllowUnauthenticatedIdentities: false
        CognitoIdentityProviders:
          - ClientId: !Ref CognitoUserPoolClient
            ProviderName: !GetAtt CognitoUserPool.ProviderName
            ServerSideTokenCheck: false

    # IAM Role for authenticated users
    CognitoAuthRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: ${self:service}-authenticated-role-${self:provider.stage}
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Federated: cognito-identity.amazonaws.com
              Action: sts:AssumeRoleWithWebIdentity
              Condition:
                StringEquals:
                  cognito-identity.amazonaws.com:aud: !Ref CognitoIdentityPool
                ForAnyValue:StringLike:
                  cognito-identity.amazonaws.com:amr: authenticated
        Policies:
          - PolicyName: CognitoAuthenticatedPolicy
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - mobileanalytics:PutEvents
                    - cognito-sync:*
                    - cognito-identity:*
                  Resource: '*'
        Tags:
          - Key: Project
            Value: my-many-books
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: auth
          - Key: CreatedBy
            Value: serverless

    # Attach role to identity pool
    CognitoIdentityPoolRoleAttachment:
      Type: AWS::Cognito::IdentityPoolRoleAttachment
      Properties:
        IdentityPoolId: !Ref CognitoIdentityPool
        Roles:
          authenticated: !GetAtt CognitoAuthRole.Arn

  # CloudFormation Outputs
  Outputs:
    CognitoUserPoolId:
      Description: Cognito User Pool ID
      Value: !Ref CognitoUserPool
      Export:
        Name: ${self:service}-${self:provider.stage}-CognitoUserPoolId

    CognitoUserPoolClientId:
      Description: Cognito User Pool Client ID
      Value: !Ref CognitoUserPoolClient
      Export:
        Name: ${self:service}-${self:provider.stage}-CognitoUserPoolClientId

    CognitoIdentityPoolId:
      Description: Cognito Identity Pool ID
      Value: !Ref CognitoIdentityPool
      Export:
        Name: ${self:service}-${self:provider.stage}-CognitoIdentityPoolId

    CognitoUserPoolArn:
      Description: Cognito User Pool ARN
      Value: !GetAtt CognitoUserPool.Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-CognitoUserPoolArn

    CognitoUserPoolDomain:
      Description: Cognito User Pool Domain
      Value: !Ref CognitoUserPoolDomain
      Export:
        Name: ${self:service}-${self:provider.stage}-CognitoUserPoolDomain

    AwsRegion:
      Description: AWS Region
      Value: ${self:provider.region}
      Export:
        Name: ${self:service}-${self:provider.stage}-AwsRegion